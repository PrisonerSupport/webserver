{"/Users/ezragoss/Projects/prisonersupport/webserver/test/servers/auth/db_utils.test.ts":{"path":"/Users/ezragoss/Projects/prisonersupport/webserver/test/servers/auth/db_utils.test.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":17},"end":{"line":3,"column":62}},"2":{"start":{"line":4,"column":14},"end":{"line":4,"column":30}},"3":{"start":{"line":5,"column":13},"end":{"line":5,"column":28}},"4":{"start":{"line":6,"column":0},"end":{"line":20,"column":3}},"5":{"start":{"line":7,"column":4},"end":{"line":13,"column":7}},"6":{"start":{"line":8,"column":8},"end":{"line":12,"column":11}},"7":{"start":{"line":9,"column":12},"end":{"line":9,"column":65}},"8":{"start":{"line":10,"column":23},"end":{"line":10,"column":60}},"9":{"start":{"line":11,"column":12},"end":{"line":11,"column":95}},"10":{"start":{"line":14,"column":4},"end":{"line":19,"column":7}},"11":{"start":{"line":15,"column":8},"end":{"line":18,"column":11}},"12":{"start":{"line":16,"column":12},"end":{"line":16,"column":72}},"13":{"start":{"line":17,"column":12},"end":{"line":17,"column":78}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":6,"column":57},"end":{"line":6,"column":58}},"loc":{"start":{"line":6,"column":69},"end":{"line":20,"column":1}},"line":6},"1":{"name":"(anonymous_1)","decl":{"start":{"line":7,"column":39},"end":{"line":7,"column":40}},"loc":{"start":{"line":7,"column":51},"end":{"line":13,"column":5}},"line":7},"2":{"name":"(anonymous_2)","decl":{"start":{"line":8,"column":49},"end":{"line":8,"column":50}},"loc":{"start":{"line":8,"column":61},"end":{"line":12,"column":9}},"line":8},"3":{"name":"(anonymous_3)","decl":{"start":{"line":14,"column":44},"end":{"line":14,"column":45}},"loc":{"start":{"line":14,"column":56},"end":{"line":19,"column":5}},"line":14},"4":{"name":"(anonymous_4)","decl":{"start":{"line":15,"column":59},"end":{"line":15,"column":60}},"loc":{"start":{"line":15,"column":71},"end":{"line":18,"column":9}},"line":15}},"branchMap":{},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1,"9":1,"10":1,"11":1,"12":1,"13":1},"f":{"0":1,"1":1,"2":1,"3":1,"4":1},"b":{},"inputSourceMap":{"version":3,"file":"/Users/ezragoss/Projects/prisonersupport/webserver/test/servers/auth/db_utils.test.ts","sources":["/Users/ezragoss/Projects/prisonersupport/webserver/test/servers/auth/db_utils.test.ts"],"names":[],"mappings":";;AAAA,+DAAiG;AACjG,+BAAoC;AACpC,6BAA6B;AAG7B,gBAAQ,CAAC,sCAAsC,EAAE;IAC7C,gBAAQ,CAAC,gBAAgB,EAAE;QACvB,UAAE,CAAC,4BAA4B,EAAE;YAC7B,qBAAU,CAAC,OAAO,EAAE,QAAQ,EAAE,UAAU,CAAC,CAAC;YAC1C,IAAI,IAAI,GAAG,4BAAiB,CAAC,OAAO,CAAC,CAAA;YACrC,aAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,QAAQ,EAAE,uCAAuC,CAAC,CAAA;QAC/E,CAAC,CAAC,CAAC;IACP,CAAC,CAAC,CAAC;IAEH,gBAAQ,CAAC,qBAAqB,EAAE;QAC5B,UAAE,CAAC,sCAAsC,EAAE;YACvC,aAAM,CAAC,uBAAY,CAAC,OAAO,EAAE,UAAU,CAAC,CAAC,CAAA;YACzC,aAAM,CAAC,CAAC,uBAAY,CAAC,OAAO,EAAE,eAAe,CAAC,CAAC,CAAA;QACnD,CAAC,CAAC,CAAC;IACP,CAAC,CAAC,CAAC;AACP,CAAC,CAAC,CAAC","sourcesContent":["import { authenticate, insertUser, getUserByUsername } from '../../../src/servers/auth/db_utils';\nimport { describe, it } from 'mocha'\nimport { expect } from 'chai'\n\n\ndescribe('Authentication database interactions', function() {\n    describe('User insertion', function () {\n        it('inserts user into database', function () {\n            insertUser('user1', 'User 1', 'password');\n            var user = getUserByUsername('user1')\n            expect(user.name).equals('User 1', 'Name of inserted entry does not match')\n        });\n    });\n\n    describe('User authentication', function() {\n        it('authenticates the password of a user', function () {\n            expect(authenticate('user1', 'password'))\n            expect(!authenticate('user1', 'wrongpassword'))\n        });\n    });\n});"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"88724dfc7bf41ccbe79f956b07ee144952b47b2d","contentHash":"47fdd5af9a477f90cb89791193f1b2ba764b42ab33aa93121047a55800d44fee"},"/Users/ezragoss/Projects/prisonersupport/webserver/src/servers/auth/db_utils.ts":{"path":"/Users/ezragoss/Projects/prisonersupport/webserver/src/servers/auth/db_utils.ts","statementMap":{"0":{"start":{"line":6,"column":0},"end":{"line":6,"column":62}},"1":{"start":{"line":7,"column":0},"end":{"line":7,"column":79}},"2":{"start":{"line":8,"column":15},"end":{"line":8,"column":32}},"3":{"start":{"line":9,"column":15},"end":{"line":9,"column":32}},"4":{"start":{"line":12,"column":4},"end":{"line":12,"column":61}},"5":{"start":{"line":12,"column":27},"end":{"line":12,"column":59}},"6":{"start":{"line":13,"column":4},"end":{"line":13,"column":82}},"7":{"start":{"line":13,"column":33},"end":{"line":13,"column":80}},"8":{"start":{"line":14,"column":15},"end":{"line":14,"column":31}},"9":{"start":{"line":15,"column":4},"end":{"line":19,"column":7}},"10":{"start":{"line":16,"column":8},"end":{"line":17,"column":22}},"11":{"start":{"line":17,"column":12},"end":{"line":17,"column":22}},"12":{"start":{"line":18,"column":8},"end":{"line":18,"column":26}},"13":{"start":{"line":21,"column":4},"end":{"line":25,"column":6}},"14":{"start":{"line":30,"column":15},"end":{"line":30,"column":81}},"15":{"start":{"line":30,"column":53},"end":{"line":30,"column":78}},"16":{"start":{"line":31,"column":4},"end":{"line":33,"column":5}},"17":{"start":{"line":32,"column":8},"end":{"line":32,"column":42}},"18":{"start":{"line":34,"column":4},"end":{"line":36,"column":5}},"19":{"start":{"line":35,"column":8},"end":{"line":35,"column":97}},"20":{"start":{"line":37,"column":4},"end":{"line":37,"column":19}},"21":{"start":{"line":39,"column":0},"end":{"line":39,"column":46}},"22":{"start":{"line":41,"column":15},"end":{"line":41,"column":36}},"23":{"start":{"line":42,"column":4},"end":{"line":42,"column":25}},"24":{"start":{"line":45,"column":4},"end":{"line":51,"column":5}},"25":{"start":{"line":46,"column":23},"end":{"line":46,"column":51}},"26":{"start":{"line":50,"column":8},"end":{"line":50,"column":18}},"27":{"start":{"line":53,"column":15},"end":{"line":53,"column":28}},"28":{"start":{"line":54,"column":21},"end":{"line":54,"column":40}},"29":{"start":{"line":55,"column":15},"end":{"line":55,"column":55}},"30":{"start":{"line":56,"column":4},"end":{"line":58,"column":5}},"31":{"start":{"line":57,"column":8},"end":{"line":57,"column":20}},"32":{"start":{"line":59,"column":4},"end":{"line":59,"column":17}},"33":{"start":{"line":61,"column":0},"end":{"line":61,"column":36}},"34":{"start":{"line":63,"column":4},"end":{"line":77,"column":5}},"35":{"start":{"line":65,"column":8},"end":{"line":65,"column":34}},"36":{"start":{"line":67,"column":8},"end":{"line":67,"column":47}},"37":{"start":{"line":71,"column":19},"end":{"line":75,"column":9}},"38":{"start":{"line":76,"column":8},"end":{"line":76,"column":22}},"39":{"start":{"line":79,"column":0},"end":{"line":79,"column":32}},"40":{"start":{"line":81,"column":9},"end":{"line":81,"column":11}}},"fnMap":{"0":{"name":"_hashAndSalt","decl":{"start":{"line":11,"column":9},"end":{"line":11,"column":21}},"loc":{"start":{"line":11,"column":50},"end":{"line":26,"column":1}},"line":11},"1":{"name":"(anonymous_1)","decl":{"start":{"line":15,"column":62},"end":{"line":15,"column":63}},"loc":{"start":{"line":15,"column":89},"end":{"line":19,"column":5}},"line":15},"2":{"name":"getUserByUsername","decl":{"start":{"line":29,"column":9},"end":{"line":29,"column":26}},"loc":{"start":{"line":29,"column":31},"end":{"line":38,"column":1}},"line":29},"3":{"name":"(anonymous_3)","decl":{"start":{"line":30,"column":35},"end":{"line":30,"column":36}},"loc":{"start":{"line":30,"column":51},"end":{"line":30,"column":80}},"line":30},"4":{"name":"_getUserPasswordById","decl":{"start":{"line":40,"column":9},"end":{"line":40,"column":29}},"loc":{"start":{"line":40,"column":34},"end":{"line":43,"column":1}},"line":40},"5":{"name":"authenticate","decl":{"start":{"line":44,"column":9},"end":{"line":44,"column":21}},"loc":{"start":{"line":44,"column":40},"end":{"line":60,"column":1}},"line":44},"6":{"name":"insertUser","decl":{"start":{"line":62,"column":9},"end":{"line":62,"column":19}},"loc":{"start":{"line":62,"column":44},"end":{"line":78,"column":1}},"line":62}},"branchMap":{"0":{"loc":{"start":{"line":12,"column":4},"end":{"line":12,"column":61}},"type":"if","locations":[{"start":{"line":12,"column":4},"end":{"line":12,"column":61}},{"start":{"line":12,"column":4},"end":{"line":12,"column":61}}],"line":12},"1":{"loc":{"start":{"line":13,"column":4},"end":{"line":13,"column":82}},"type":"if","locations":[{"start":{"line":13,"column":4},"end":{"line":13,"column":82}},{"start":{"line":13,"column":4},"end":{"line":13,"column":82}}],"line":13},"2":{"loc":{"start":{"line":16,"column":8},"end":{"line":17,"column":22}},"type":"if","locations":[{"start":{"line":16,"column":8},"end":{"line":17,"column":22}},{"start":{"line":16,"column":8},"end":{"line":17,"column":22}}],"line":16},"3":{"loc":{"start":{"line":31,"column":4},"end":{"line":33,"column":5}},"type":"if","locations":[{"start":{"line":31,"column":4},"end":{"line":33,"column":5}},{"start":{"line":31,"column":4},"end":{"line":33,"column":5}}],"line":31},"4":{"loc":{"start":{"line":34,"column":4},"end":{"line":36,"column":5}},"type":"if","locations":[{"start":{"line":34,"column":4},"end":{"line":36,"column":5}},{"start":{"line":34,"column":4},"end":{"line":36,"column":5}}],"line":34},"5":{"loc":{"start":{"line":56,"column":4},"end":{"line":58,"column":5}},"type":"if","locations":[{"start":{"line":56,"column":4},"end":{"line":58,"column":5}},{"start":{"line":56,"column":4},"end":{"line":58,"column":5}}],"line":56}},"s":{"0":1,"1":1,"2":1,"3":1,"4":3,"5":1,"6":3,"7":1,"8":3,"9":3,"10":3,"11":0,"12":3,"13":3,"14":4,"15":3,"16":4,"17":1,"18":3,"19":0,"20":3,"21":1,"22":2,"23":2,"24":2,"25":2,"26":0,"27":2,"28":2,"29":2,"30":2,"31":0,"32":2,"33":1,"34":1,"35":1,"36":0,"37":1,"38":1,"39":1,"40":1},"f":{"0":3,"1":3,"2":4,"3":3,"4":2,"5":2,"6":1},"b":{"0":[1,2],"1":[1,2],"2":[0,3],"3":[1,3],"4":[0,3],"5":[0,2]},"inputSourceMap":{"version":3,"file":"/Users/ezragoss/Projects/prisonersupport/webserver/src/servers/auth/db_utils.ts","sources":["/Users/ezragoss/Projects/prisonersupport/webserver/src/servers/auth/db_utils.ts"],"names":[],"mappings":";AAAA;;;GAGG;;;AAEH,iCAAoE;AACpE,iCAAgC;AAchC,0BAA0B;AAE1B,SAAS,YAAY,CAAC,QAAe,EAAE,IAA+B,EAAE,UAAyC;IAA1E,qBAAA,EAAA,OAAgB,oBAAW,CAAC,EAAE,CAAC;IAAE,2BAAA,EAAA,aAAkB,kBAAS,CAAC,KAAK,EAAC,MAAM,CAAC;IAC7G,IAAI,IAAI,GAAW,MAAM,CAAC,KAAK,CAAC,EAAE,CAAC,CAAA,CAAE,kDAAkD;IACvF,eAAM,CACF,QAAQ,EACR,IAAI,EACJ,UAAU,EACV,EAAE,EACF,QAAQ,EACR,UAAC,GAAG,EAAE,UAAU;QACZ,IAAI,GAAG;YAAE,MAAM,GAAG,CAAA;QAClB,IAAI,GAAG,UAAU,CAAA;IACrB,CAAC,CACJ,CAAC;IACF,sDAAsD;IACtD,OAAO;QACH,MAAM,EAAE,IAAI;QACZ,MAAM,EAAE,IAAI;QACZ,YAAY,EAAE,UAAU;KAC3B,CAAA;AACL,CAAC;AAED,2BAA2B;AAC3B,yFAAyF;AAEzF,SAAS,iBAAiB,CAAC,EAAS;IAChC,IAAI,IAAI,GAAG,eAAM,CAAC,EAAE,EAAE,UAAA,IAAI,IAAI,OAAA,IAAI,CAAC,MAAM,IAAI,EAAE,EAAjB,CAAiB,CAAC,CAAC;IAEjD,IAAI,IAAI,CAAC,MAAM,IAAI,CAAC,EAAE;QAClB,MAAM,IAAI,KAAK,CAAC,gBAAgB,CAAC,CAAC;KACrC;IAED,IAAI,IAAI,CAAC,MAAM,GAAG,CAAC,EAAE;QACjB,MAAM,IAAI,KAAK,CAAC,uEAAuE,CAAC,CAAC;KAC5F;IAED,OAAO,IAAI,CAAC,CAAC,CAAC,CAAC,CAAE,mCAAmC;AACxD,CAAC;AAmDkC,8CAAiB;AAjDpD,SAAS,oBAAoB,CAAC,EAAS;IACnC,IAAI,IAAI,GAAG,iBAAiB,CAAC,EAAE,CAAC,CAAC;IAEjC,OAAO,IAAI,CAAC,QAAQ,CAAC;AACzB,CAAC;AAED,SAAS,YAAY,CAAC,MAAa,EAAE,QAAe;IAChD,IAAI;QACA,IAAI,QAAQ,GAAG,oBAAoB,CAAC,MAAM,CAAC,CAAA;KAC9C;IACD,OAAO,GAAG,EAAE;QACR,+CAA+C;QAC/C,MAAM,GAAG,CAAA;KACZ;IAED,gGAAgG;IAChG,IAAI,IAAI,GAAG,QAAQ,CAAC,IAAI,CAAA;IACxB,IAAI,UAAU,GAAG,QAAQ,CAAC,UAAU,CAAA;IACpC,IAAI,IAAI,GAAG,YAAY,CAAC,QAAQ,EAAE,IAAI,EAAE,UAAU,CAAC,CAAA;IAEnD,IAAI,IAAI,IAAI,QAAQ,EAAE;QAClB,OAAO,IAAI,CAAA;KACd;IAED,OAAO,KAAK,CAAA;AAChB,CAAC;AAwBQ,oCAAY;AAtBrB,SAAS,UAAU,CAAC,MAAa,EAAE,IAAW,EAAE,QAAe;IAC3D,IAAI;QACA,2BAA2B;QAC3B,iBAAiB,CAAC,MAAM,CAAC,CAAC;QAC1B,0CAA0C;QAC1C,MAAM,IAAI,KAAK,CAAC,qBAAqB,CAAC,CAAA;KACzC;IAAC,OAAO,GAAG,EAAE;QACV,+CAA+C;QAC/C,IAAI,IAAI,GAAG;YACP,QAAQ,EAAE,MAAM;YAChB,MAAM,EAAE,IAAI;YACZ,UAAU,EAAE,YAAY,CAAC,QAAQ,CAAC;SACrC,CAAA;QACD,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;KAChB;AACL,CAAC;AAOsB,gCAAU;AALjC,yFAAyF;AAEzF,IAAI,EAAE,GAAW,EAChB,CAAA","sourcesContent":["/**\n * FIXME: CURRENTLY USING DUMMY PLAINTEXT DB\n * \n */\n\nimport { BinaryLike, pbkdf2, randomBytes, randomInt } from 'crypto';\nimport { filter } from 'lodash';\n\n\n// ---- TYPE INTERFACES ----\ninterface User {\n    'userId': string,\n    'name': string,\n    'password': {\n        'hash': BinaryLike,\n        'salt': BinaryLike,\n        'iterations': number\n    }\n}\n\n// ---- HASHING LOGIC ----\n\nfunction _hashAndSalt(password:string, salt:BinaryLike=randomBytes(16), iterations:number=randomInt(80000,100000)) {\n    var hash: Buffer = Buffer.alloc(32)  // Allocate default buffer, TODO: this feels janky\n    pbkdf2(\n        password,\n        salt,\n        iterations,\n        32,\n        'sha256',\n        (err, derivedKey) => {\n            if (err) throw err\n            hash = derivedKey\n        }\n    );\n    // Return a dictionary of attributes for storage in db\n    return {\n        'hash': hash,\n        'salt': salt,\n        'iterations': iterations\n    }\n}\n\n// ---- DB QUERY TOOLS ----\n// TODO: These are just fillers for testing, need to replace with actual DB and its logic\n\nfunction getUserByUsername(id:string) {\n    var user = filter(db, user => user.userId == id);\n\n    if (user.length == 0) {\n        throw new Error(\"User not found\");\n    }\n\n    if (user.length > 1) {\n        throw new Error(\"More than one user found for that ID, please check DB insertion logic\");\n    }\n\n    return user[0];  // Should only be one user in array\n}\n\nfunction _getUserPasswordById(id:string) {\n    var user = getUserByUsername(id);\n\n    return user.password;\n}\n\nfunction authenticate(userId:string, password:string) {\n    try {\n        var expected = _getUserPasswordById(userId)\n    }\n    catch (err) {\n        // Something went wrong, just pass up the error\n        throw err\n    }\n    \n    // Use the same salt and iteration count that the user originally used to retrieve the same hash\n    var salt = expected.salt\n    var iterations = expected.iterations\n    var hash = _hashAndSalt(password, salt, iterations)\n    \n    if (hash == expected) {\n        return true\n    }\n\n    return false\n}\n\nfunction insertUser(userId:string, name:string, password:string) {\n    try {\n        // Check if the user exists\n        getUserByUsername(userId);\n        // If user exists then throw back an error\n        throw new Error(\"User already exists\")\n    } catch (err) {\n        // User doesn't exist, generate hash and insert\n        var user = {\n            'userId': userId,\n            'name': name,\n            'password': _hashAndSalt(password)\n        }\n        db.push(user)\n    }\n}\n\n// TODO: This is just a dummy plaintext DB and needs to be removed once real DB is set up\n\nvar db: User[] = [\n]\n\nexport { authenticate, insertUser, getUserByUsername };"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"09565c37aaa3b90d87bfc6fd3fb87dfa13f4b24e","contentHash":"f1c0cd35ff07e5cef5b0f1f2804fcfe6488b3171179de60229fcb78498a38bb0"}}